<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1528px" preserveAspectRatio="none" style="width:1313px;height:1528px;" version="1.1" viewBox="0 0 1313 1528" width="1313px" zoomAndPan="magnify"><defs><filter height="300%" id="fjmyul4shuq46" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="293" x="511.25" y="27.4023">10.6. Thirdparty Notification Flow</text><rect fill="#FFFFE0" height="1478.6738" style="stroke: #A80036; stroke-width: 1.0;" width="412" x="160" y="39.1992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="312" y="51.7676">Central Services</text><rect fill="#90EE90" height="1478.6738" style="stroke: #A80036; stroke-width: 1.0;" width="712.5" x="574" y="39.1992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="220" x="820.25" y="51.7676">Central Event Processing Service</text><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="347.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="232.5" y="130.998"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="177.7734" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="657" y="478.8984"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="409.8125" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="657" y="1025.5723"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="148.4629" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="849.5" y="508.209"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="380.502" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="849.5" y="1054.8828"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="58.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1241.5" y="598.0508"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1241.5" y="1129.5918"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1241.5" y="1361.7637"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="526.6738" style="stroke: #000000; stroke-width: 2.0;" width="1273.5" x="19" y="137.998"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="756.7129" style="stroke: #000000; stroke-width: 2.0;" width="1289.5" x="13" y="678.6719"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="254.4824" style="stroke: #000000; stroke-width: 2.0;" width="981.5" x="311" y="1173.9023"/><rect fill="#FFFFFF" height="192.7285" style="stroke: none; stroke-width: 1.0;" width="981.5" x="311" y="1235.6563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="237" x2="237" y1="120.998" y2="1452.3848"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="444" x2="444" y1="120.998" y2="1452.3848"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="662" x2="662" y1="120.998" y2="1452.3848"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="854" x2="854" y1="120.998" y2="1452.3848"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1246.5" x2="1246.5" y1="120.998" y2="1452.3848"/><rect fill="#FEFECE" filter="url(#fjmyul4shuq46)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="168" y="81.5098"/><rect fill="#FEFECE" filter="url(#fjmyul4shuq46)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="164" y="85.5098"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="171" y="106.0449">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fjmyul4shuq46)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="168" y="1451.3848"/><rect fill="#FEFECE" filter="url(#fjmyul4shuq46)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="164" y="1455.3848"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="171" y="1475.9199">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fjmyul4shuq46)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="239" x="325" y="81.5098"/><rect fill="#FEFECE" filter="url(#fjmyul4shuq46)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="239" x="321" y="85.5098"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="225" x="328" y="106.0449">Notification-Thirdparty-Transfer</text><rect fill="#FEFECE" filter="url(#fjmyul4shuq46)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="239" x="325" y="1451.3848"/><rect fill="#FEFECE" filter="url(#fjmyul4shuq46)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="239" x="321" y="1455.3848"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="225" x="328" y="1475.9199">Notification-Thirdparty-Transfer</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="162" x="578" y="118.0449">Central Event Processor</text><ellipse cx="662" cy="88.5098" fill="#FEFECE" filter="url(#fjmyul4shuq46)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="658,76.5098,664,71.5098,662,76.5098,664,81.5098,658,76.5098" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="162" x="578" y="1464.9199">Central Event Processor</text><ellipse cx="662" cy="1483.873" fill="#FEFECE" filter="url(#fjmyul4shuq46)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="658,1471.873,664,1466.873,662,1471.873,664,1476.873,658,1471.873" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="145" x="779" y="118.0449">thirdpartyObservable</text><ellipse cx="854.5" cy="88.5098" fill="#FEFECE" filter="url(#fjmyul4shuq46)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="850.5,76.5098,856.5,71.5098,854.5,76.5098,856.5,81.5098,850.5,76.5098" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="145" x="779" y="1464.9199">thirdpartyObservable</text><ellipse cx="854.5" cy="1483.873" fill="#FEFECE" filter="url(#fjmyul4shuq46)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="850.5,1471.873,856.5,1466.873,854.5,1471.873,856.5,1476.873,850.5,1471.873" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="1210.5" y="118.0449">CEP Store</text><path d="M1228.5,68.5098 C1228.5,58.5098 1246.5,58.5098 1246.5,58.5098 C1246.5,58.5098 1264.5,58.5098 1264.5,68.5098 L1264.5,94.5098 C1264.5,104.5098 1246.5,104.5098 1246.5,104.5098 C1246.5,104.5098 1228.5,104.5098 1228.5,94.5098 L1228.5,68.5098 " fill="#FEFECE" filter="url(#fjmyul4shuq46)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1228.5,68.5098 C1228.5,78.5098 1246.5,78.5098 1246.5,78.5098 C1246.5,78.5098 1264.5,78.5098 1264.5,68.5098 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="1210.5" y="1464.9199">CEP Store</text><path d="M1228.5,1477.873 C1228.5,1467.873 1246.5,1467.873 1246.5,1467.873 C1246.5,1467.873 1264.5,1467.873 1264.5,1477.873 L1264.5,1503.873 C1264.5,1513.873 1246.5,1513.873 1246.5,1513.873 C1246.5,1513.873 1228.5,1513.873 1228.5,1503.873 L1228.5,1477.873 " fill="#FEFECE" filter="url(#fjmyul4shuq46)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1228.5,1477.873 C1228.5,1487.873 1246.5,1487.873 1246.5,1487.873 C1246.5,1487.873 1264.5,1487.873 1264.5,1477.873 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="347.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="232.5" y="130.998"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="177.7734" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="657" y="478.8984"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="409.8125" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="657" y="1025.5723"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="148.4629" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="849.5" y="508.209"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="380.502" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="849.5" y="1054.8828"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="58.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1241.5" y="598.0508"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1241.5" y="1129.5918"/><rect fill="#FFFFFF" filter="url(#fjmyul4shuq46)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1241.5" y="1361.7637"/><path d="M19,137.998 L182,137.998 L182,144.998 L172,154.998 L19,154.998 L19,137.998 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="526.6738" style="stroke: #000000; stroke-width: 2.0;" width="1273.5" x="19" y="137.998"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="34" y="151.5664">Subscription Flow</text><path d="M288,160.3086 L288,215.3086 L1031,215.3086 L1031,170.3086 L1021,160.3086 L288,160.3086 " fill="#FBFB77" filter="url(#fjmyul4shuq46)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1021,160.3086 L1021,170.3086 L1031,170.3086 L1021,160.3086 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="722" x="294" y="177.877">The Subscription Flow listens for `subscription` events on the notifications topic, and saves them to the database</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="538" x="294" y="193.1875">such an event could be emitted during the `POST /authorizations` step, provided the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="294" y="208.498">transferId is specified by the PISP ahead of time.</text><rect fill="#D3D3D3" filter="url(#fjmyul4shuq46)" height="222" style="stroke: #A80036; stroke-width: 1.0;" width="416" x="29" y="230.2402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="33" y="246.8086">Example Event</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="33" y="262.1191">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="49" y="277.4297">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="65" y="292.7402">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="81" y="308.0508">type: "notification",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="81" y="323.3613">action: "subscription",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="81" y="338.6719">id: '1111-2222-3333',   //transferId to look for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="81" y="353.9824">participantId: 'pispA', //id of the pisp to send callback to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="81" y="369.293">...</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="65" y="384.6035">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="65" y="399.9141">...</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="49" y="415.2246">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="49" y="430.5352">...</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="33" y="445.8457">}</text><polygon fill="#A80036" points="645,474.8984,655,478.8984,645,482.8984,649,478.8984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237.5" x2="651" y1="478.8984" y2="478.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="244.5" y="474.1563">1</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="257.5" y="473.7437">consume(event)</text><polygon fill="#A80036" points="837.5,504.209,847.5,508.209,837.5,512.209,841.5,508.209" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="667" x2="843.5" y1="508.209" y2="508.209"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="674" y="503.4668">2</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="687" y="503.0542">handle(event)</text><polygon fill="#A80036" points="1229.5,594.0508,1239.5,598.0508,1229.5,602.0508,1233.5,598.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="859.5" x2="1235.5" y1="598.0508" y2="598.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="866.5" y="563.043">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="247" x="879.5" y="532.7773">Create the subscription in the database</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="879.5" y="547.5864">document.create({</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="895.5" y="562.7192">transferId: '1111-2222-3333',</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="895.5" y="577.8521">participantId: 'pispA'</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="879.5" y="592.9849">})</text><polygon fill="#A80036" points="870.5,623.3613,860.5,627.3613,870.5,631.3613,866.5,627.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="864.5" x2="1240.5" y1="627.3613" y2="627.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="876.5" y="622.6191">4</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="889.5" y="622.2065">Promise.resolve(document)</text><polygon fill="#A80036" points="673,652.6719,663,656.6719,673,660.6719,669,656.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="667" x2="853.5" y1="656.6719" y2="656.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="679" y="651.9297">5</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="692" y="651.5171">Promise.resolve()</text><path d="M13,678.6719 L149,678.6719 L149,685.6719 L139,695.6719 L13,695.6719 L13,678.6719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="756.7129" style="stroke: #000000; stroke-width: 2.0;" width="1289.5" x="13" y="678.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="91" x="28" y="692.2402">Callback Flow</text><path d="M369,700.9824 L369,771.9824 L951,771.9824 L951,710.9824 L941,700.9824 L369,700.9824 " fill="#FBFB77" filter="url(#fjmyul4shuq46)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M941,700.9824 L941,710.9824 L951,710.9824 L941,700.9824 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="549" x="375" y="718.5508">The Callback Flow listens for `commit` events on the notifications topic. It then filters</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="529" x="375" y="733.8613">events based on their subscription: if there is a subscription in the database, then it</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="561" x="375" y="749.1719">forwards the message over the `notification-thirdparty-transfer` topic, and removes the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="375" y="764.4824">subscription from the database.</text><path d="M23,786.2246 L23,995.2246 L448,995.2246 L448,796.2246 L438,786.2246 L23,786.2246 " fill="#D3D3D3" filter="url(#fjmyul4shuq46)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M438,786.2246 L438,796.2246 L448,796.2246 L438,786.2246 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="29" y="803.793">Example Event</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="819.1035">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="45" y="834.4141">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="61" y="849.7246">correlationId: '1111-2222-3333',   //transferId to look for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="61" y="865.0352">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="77" y="880.3457">type: "notification",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="77" y="895.6563">action: "commit",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="73" y="910.9668">...</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="61" y="926.2773">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="61" y="941.5879">...</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="45" y="956.8984">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="45" y="972.209">...</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="987.5195">}</text><polygon fill="#A80036" points="645,1021.5723,655,1025.5723,645,1029.5723,649,1025.5723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="237.5" x2="651" y1="1025.5723" y2="1025.5723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="244.5" y="1020.8301">6</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="257.5" y="1020.4175">consume(event)</text><polygon fill="#A80036" points="837.5,1050.8828,847.5,1054.8828,837.5,1058.8828,841.5,1054.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="667" x2="843.5" y1="1054.8828" y2="1054.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="674" y="1050.1406">7</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="687" y="1049.728">handle(event)</text><polygon fill="#A80036" points="1229.5,1125.5918,1239.5,1129.5918,1229.5,1133.5918,1233.5,1129.5918" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="859.5" x2="1235.5" y1="1129.5918" y2="1129.5918"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="866.5" y="1102.1504">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="879.5" y="1079.4512">Lookup in the database to see if we have a subscription</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="879.5" y="1094.2603">document.findOne({</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="895.5" y="1109.3931">transferId: '1111-2222-3333',</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="879.5" y="1124.5259">})</text><polygon fill="#A80036" points="870.5,1154.9023,860.5,1158.9023,870.5,1162.9023,866.5,1158.9023" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="864.5" x2="1245.5" y1="1158.9023" y2="1158.9023"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="876.5" y="1154.1602">9</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="889.5" y="1153.7476">Promise.resolve(document | null)</text><path d="M311,1173.9023 L373,1173.9023 L373,1180.9023 L363,1190.9023 L311,1190.9023 L311,1173.9023 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="254.4824" style="stroke: #000000; stroke-width: 2.0;" width="981.5" x="311" y="1173.9023"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="326" y="1187.4707">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="388" y="1186.5371">[</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="392" y="1186.5371">No Suscription</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="36" x="478" y="1186.5371">exists]</text><polygon fill="#A80036" points="678,1223.6563,668,1227.6563,678,1231.6563,674,1227.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="672" x2="848.5" y1="1227.6563" y2="1227.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="684" y="1215.3477">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="706" y="1207.7813">Do nothing</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="706" y="1222.5903">Promise.resolve()</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="311" x2="1292.5" y1="1236.6563" y2="1236.6563"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="316" y="1247.291">[</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="320" y="1247.291">Found Suscription</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="421" y="1247.291">]</text><polygon fill="#A80036" points="455.5,1283.0547,445.5,1287.0547,455.5,1291.0547,451.5,1287.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="449.5" x2="848.5" y1="1287.0547" y2="1287.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="461.5" y="1274.7461">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="483.5" y="1267.1797">Publish to</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="550.5" y="1266.856">notification-thirdparty-transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="810.5" y="1267.1797">topic</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="483.5" y="1281.9888">publish(event)</text><polygon fill="#A80036" points="1229.5,1357.7637,1239.5,1361.7637,1229.5,1365.7637,1233.5,1361.7637" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="859.5" x2="1235.5" y1="1361.7637" y2="1361.7637"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="866.5" y="1334.3223">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="888.5" y="1311.623">Delete the subscription</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="888.5" y="1326.4321">document.delete({</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="904.5" y="1341.5649">transferId: '1111-2222-3333',</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="888.5" y="1356.6978">})</text><polygon fill="#A80036" points="870.5,1387.0742,860.5,1391.0742,870.5,1395.0742,866.5,1391.0742" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="864.5" x2="1245.5" y1="1391.0742" y2="1391.0742"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="876.5" y="1386.332">13</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="898.5" y="1385.9194">Promise.resolve()</text><polygon fill="#A80036" points="678,1416.3848,668,1420.3848,678,1424.3848,674,1420.3848" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="672" x2="848.5" y1="1420.3848" y2="1420.3848"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="684" y="1415.6426">14</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="706" y="1415.23">Promise.resolve()</text><!--MD5=[7f51df318e64fd7db7ef564e7cdb9503]
@startuml
' declate title
title 10.6. Thirdparty Notification Flow
autonumber

' declare actors
collections "Notification-Topic" as topicNotify
collections "Notification-Thirdparty-Transfer" as 3pTopicTransfer
control "Central Event Processor" as CEP
control "thirdpartyObservable" as SUB
' control "Action Agent" as AA
database "CEP Store" as DB

box "Central Services" #LightYellow
participant topicNotify
participant 3pTopicTransfer
end box
box "Central Event Processing Service" #LightGreen
participant CEP
participant SUB
participant DB
end box

' start flow
Group Subscription Flow
    note over CEP
        The Subscription Flow listens for `subscription` events on the notifications topic, and saves them to the database
        such an event could be emitted during the `POST /authorizations` step, provided the 
        transferId is specified by the PISP ahead of time.
    end note

    rnote over topicNotify #LightGray
        **Example Event**
        {   
            metadata: {
                event: {
                    type: "notification",
                    action: "subscription", 
                    id: '1111-2222-3333',   //transferId to look for 
                    participantId: 'pispA', //id of the pisp to send callback to
                    ...
                }
                ...
            }
            ...
        }
    end note
    activate topicNotify
    topicNotify -> CEP: ""consume(event)""
    deactivate topicNotify

    activate CEP
    CEP -> SUB: ""handle(event)""
    activate SUB
    SUB -> DB: Create the subscription in the database\n""document.create({""\n""  transferId: '1111-2222-3333',""\n""  participantId: 'pispA'""\n""})""
    activate DB
    DB - -> SUB: ""Promise.resolve(document)""
    SUB - -> CEP: ""Promise.resolve()""
    deactivate DB
    deactivate SUB
    deactivate CEP
end

Group Callback Flow
    note over CEP
        The Callback Flow listens for `commit` events on the notifications topic. It then filters
        events based on their subscription: if there is a subscription in the database, then it
        forwards the message over the `notification-thirdparty-transfer` topic, and removes the
        subscription from the database.
    end note

    note over topicNotify #LightGray
        **Example Event**
        { 
            metadata: {
                correlationId: '1111-2222-3333',   //transferId to look for 
                event: {
                    type: "notification",
                    action: "commit", 
                   ...
                }
                ...
            }
            ...
        }
    end note
    activate topicNotify
    topicNotify -> CEP: ""consume(event)""
    deactivate topicNotify

    activate CEP
    CEP -> SUB: ""handle(event)""
    activate SUB
    SUB -> DB: Lookup in the database to see if we have a subscription\n""document.findOne({""\n""  transferId: '1111-2222-3333',""\n""})""
    activate DB
    DB - -> SUB: ""Promise.resolve(document | null)""
    deactivate DB
    alt **No Suscription** exists
        SUB - -> CEP: Do nothing\n""Promise.resolve()""   
    else  **Found Suscription**
        SUB -> 3pTopicTransfer: Publish to ""notification-thirdparty-transfer"" topic\n""publish(event)""
        SUB -> DB: Delete the subscription\n""document.delete({""\n""  transferId: '1111-2222-3333',""\n""})""
        activate DB
        DB - -> SUB: ""Promise.resolve()""
        deactivate DB
        SUB - -> CEP: ""Promise.resolve()""
    end

    deactivate SUB
    deactivate CEP

end

    ' CEP -> AA: Action event

'     alt **Action Object** exist
'         AA -> DB: Request **Event Object**  details
'         activate DB
'         deactivate DB
'         hnote over DB #LightYellow
'             event
'         end hnote
'         note right of AA #LightGrey
'             **Event Object** details;
'                 Action details,
'                 Hub notification details,
'                 DFSP notification details.
'         end note
'         AA -> AA: Prepare notification details
'         AA -> DB: Request **Action Object** by same **Event Object** details
'         activate DB
'         deactivate DB
'         hnote over DB #LightYellow
'             action
'         end hnote

'         alt No previous **Action Object** with same event detail
'             AA -> DB: Store **Action Object**
'             activate DB
'             hnote over DB #LightYellow
'                 action
'             end hnote
'             AA <- - DB: Return result **actionId**
'             deactivate DB
'             AA -> AA: Schedule reset repetition for **actionId** as per rules
'             note left of AA #yellow
'                 {from: "SYSTEM"}
'             end note
'             topicNotify <- AA: Update topic with notification
'             activate topicNotify
'             deactivate topicNotify
'         else Previous **Action Object** with same event detail

'             alt Repetition and notification interval allowed
'                 AA -> AA: Increment repetition counter
'                 AA -> DB: Update **Action Object**
'                 activate DB
'                 hnote over DB #LightYellow
'                     action
'                 end hnote
'                 deactivate DB
'             else Repetition and notification interval not allowed
'             end
'             note left of AA #yellow
'                 {from: "SYSTEM"}
'             end note
'             topicNotify <- AA: Update topic with notification
'             activate topicNotify
'             deactivate topicNotify
'         end
'     else No **Action Object** exist
'     deactivate AA
'     end
' end
'     deactivate CEP
@enduml

@startuml
title 10.6. Thirdparty Notification Flow
autonumber

collections "Notification-Topic" as topicNotify
collections "Notification-Thirdparty-Transfer" as 3pTopicTransfer
control "Central Event Processor" as CEP
control "thirdpartyObservable" as SUB
database "CEP Store" as DB

box "Central Services" #LightYellow
participant topicNotify
participant 3pTopicTransfer
end box
box "Central Event Processing Service" #LightGreen
participant CEP
participant SUB
participant DB
end box

Group Subscription Flow
    note over CEP
        The Subscription Flow listens for `subscription` events on the notifications topic, and saves them to the database
        such an event could be emitted during the `POST /authorizations` step, provided the 
        transferId is specified by the PISP ahead of time.
    end note

    rnote over topicNotify #LightGray
        **Example Event**
        {   
            metadata: {
                event: {
                    type: "notification",
                    action: "subscription", 
                    id: '1111-2222-3333',   //transferId to look for 
                    participantId: 'pispA', //id of the pisp to send callback to
                    ...
                }
                ...
            }
            ...
        }
    end note
    activate topicNotify
    topicNotify -> CEP: ""consume(event)""
    deactivate topicNotify

    activate CEP
    CEP -> SUB: ""handle(event)""
    activate SUB
    SUB -> DB: Create the subscription in the database\n""document.create({""\n""  transferId: '1111-2222-3333',""\n""  participantId: 'pispA'""\n""})""
    activate DB
    DB - -> SUB: ""Promise.resolve(document)""
    SUB - -> CEP: ""Promise.resolve()""
    deactivate DB
    deactivate SUB
    deactivate CEP
end

Group Callback Flow
    note over CEP
        The Callback Flow listens for `commit` events on the notifications topic. It then filters
        events based on their subscription: if there is a subscription in the database, then it
        forwards the message over the `notification-thirdparty-transfer` topic, and removes the
        subscription from the database.
    end note

    note over topicNotify #LightGray
        **Example Event**
        { 
            metadata: {
                correlationId: '1111-2222-3333',   //transferId to look for 
                event: {
                    type: "notification",
                    action: "commit", 
                   ...
                }
                ...
            }
            ...
        }
    end note
    activate topicNotify
    topicNotify -> CEP: ""consume(event)""
    deactivate topicNotify

    activate CEP
    CEP -> SUB: ""handle(event)""
    activate SUB
    SUB -> DB: Lookup in the database to see if we have a subscription\n""document.findOne({""\n""  transferId: '1111-2222-3333',""\n""})""
    activate DB
    DB - -> SUB: ""Promise.resolve(document | null)""
    deactivate DB
    alt **No Suscription** exists
        SUB - -> CEP: Do nothing\n""Promise.resolve()""   
    else  **Found Suscription**
        SUB -> 3pTopicTransfer: Publish to ""notification-thirdparty-transfer"" topic\n""publish(event)""
        SUB -> DB: Delete the subscription\n""document.delete({""\n""  transferId: '1111-2222-3333',""\n""})""
        activate DB
        DB - -> SUB: ""Promise.resolve()""
        deactivate DB
        SUB - -> CEP: ""Promise.resolve()""
    end

    deactivate SUB
    deactivate CEP

end




@enduml

PlantUML version 1.2020.10(Sun May 17 17:35:57 PHT 2020)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_171-b11
Operating System: Mac OS X
Default Encoding: UTF-8
Language: en
Country: AU
--></g></svg>